<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC|Booking Science LAB v1</title> <link rel="shortcut icon" type="image/png" href="https://img2.pic.in.th/pic/Pakchong_School-removebg-preview.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap.min.css">
    <link href='https://fonts.googleapis.com/css?family=Itim|Kanit|Mali|Mitr|Niramit|Pattaya|Prompt|Questrial|Sarabun|Sriracha' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css2?family=Niramit:wght@400&display=swap" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />

    <style>
        body {
            font-family: 'Niramit', sans-serif;
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .panel-primary > .panel-heading {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        .panel-default > .panel-heading {
            background-color: #f5f5f5; /* Lighter heading for default panel */
            border-color: #ddd;
            color: #333;
        }
        .panel {
             border-radius: 4px;
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
             margin-bottom: 20px;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover, .btn-primary:focus {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .input-group {
            min-width: 120px;
            text-align: left;
        }
        .input-group-addon .fas {
            margin-right: 8px;
        }
        #bookingTable th {
            background-color: #e9ecef;
        }
        table.dataTable.dtr-inline.collapsed>tbody>tr[role="row"]>td:first-child:before,
        table.dataTable.dtr-inline.collapsed>tbody>tr[role="row"]>th:first-child:before {
            background-color: #007bff;
            color: white;
        }
        .help-block {
            color: #737373;
        }
        .form-spacing {
            margin-bottom: 15px;
        }
        .nav-tabs > li > a {
            font-size: 16px;
        }
        .nav-tabs > li.active > a,
        .nav-tabs > li.active > a:hover,
        .nav-tabs > li.active > a:focus {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            border-bottom-color: transparent;
        }
        .tab-content {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-top: none;
            background-color: #fff;
            border-radius: 0 0 4px 4px;
        }
        /* Calendar specific styles */
        #bookingCalendar {
            max-width: 1100px;
            margin: 0 auto;
        }
        .fc-event {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
	<div class="card shadow-sm border-primary position-relative" style="padding: 15px; margin-bottom: 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);">
    <div class="card-body p-3 p-md-4">
        <h3 class="text-center" style="margin-bottom: 20px; text-align: center; background-color : #353ffc; color:#faf7f7;font-mt-5; font-mb-5; font-weight: 300; border-bottom: 2px solid var(--step-line-color); padding-bottom: 20px; padding-top: 20px; margin-top: 5px; margin-bottom: 20px;"><i class="fas fa-flask-vial"></i><b> ระบบจองห้องปฏิบัติการวิทยาศาสตร์</b></h3>

        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a href="#bookingFormTab" aria-controls="bookingFormTab" role="tab" data-toggle="tab"><i class="fas fa-edit"></i> แบบฟอร์มการจอง</a></li>
            <li role="presentation"><a href="#bookingTableTab" aria-controls="bookingTableTab" role="tab" data-toggle="tab"><i class="fas fa-table"></i> ข้อมูลการจอง</a></li>
            <li role="presentation"><a href="#calendarViewTab" aria-controls="calendarViewTab" role="tab" data-toggle="tab"><i class="fas fa-calendar-alt"></i> ปฏิทินการจอง</a></li>
        </ul>

        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="bookingFormTab">
                <div class="panel panel-primary" style="margin-top:2px; box-shadow: none; border: none;">
                    <div class="panel-body" style="padding:0px; mb-5">
                        <form id="bookingForm">
                            <div class="row"> <div class="col-md-6" style="margin-bottom: 10px;">
                                    <label for="requesterName"><i class="fas fa-user fa-bounce"></i> ชื่อผู้จอง</label>
                                        <select class="form-control" id="requesterName" name="requesterName" required>
                                            <option value="" disabled selected>เลือก...</option>
                                            <option value="อ.ธนบดี">อ.ธนบดี</option>
                                            <option value="อ.ธนสาร">อ.ธนสาร</option>
                                            <option value="อ.ณัฐชา">อ.ณัฐชา</option>
                                            <option value="อ.สุจิตตรา">อ.สุจิตตรา</option>
                                            <option value="อ.จุฑามาศ">อ.จุฑามาศ</option>
                                            <option value="อ.ปัทมา">อ.ปัทมา</option>
                                            <option value="อ.จริญญา">อ.จริญญา</option>
                                            <option value="อ.แสนชัย">อ.แสนชัย</option>
                                            <option value="อ.นันทวัฒน์">อ.นันทวัฒน์</option>
                                            <option value="อ.รังสรรค์">อ.รังสรรค์</option>
                                            <option value="อ.บุญโย">อ.บุญโย</option>
                                            <option value="อ.สุภัค">อ.สุภัค</option>
                                            <option value="อ.พิมล">อ.พิมล</option>
                                            <option value="อ.สุดา">อ.สุดา</option>
                                            <option value="อ.กิตติมา">อ.กิตติมา</option>
                                            <option value="อ.ณภัชนันท์">อ.ณภัชนันท์</option>
                                            <option value="อ.ปริชาติ">อ.ปริชาติ</option>
                                            <option value="อ.ฉัตรฉัย">อ.ฉัตรฉัย</option>
                                            <option value="อ.อรนุช">อ.อรนุช</option>
                                            <option value="อ.กนิษฐา">อ.กนิษฐา</option>
                                            <option value="อ.สุนิษา">อ.สุนิษา</option>
                                            <option value="อื่นๆ">อื่นๆ</option>
                                        </select>
                                    </div>

                                <div class="col-md-6" style="margin-bottom: 10px;">
                                    <label for="fieldOfStudy"><i class="fas fa-atom fa-bounce"></i> สาขาวิชา</label>
                                        <select class="form-control" id="fieldOfStudy" name="fieldOfStudy" required>
                                            <option value="" disabled selected>เลือกสาขาวิชา...</option>
                                            <option value="ฟิสิกส์">ฟิสิกส์</option>
                                            <option value="เคมี">เคมี</option>
                                            <option value="ชีววิทยา">ชีววิทยา</option>
                                        </select>
                                    </div>

                                <div class="col-md-6" style="margin-bottom: 10px;">
                                    <label for="labRequested"><i class="fas fa-microscope fa-bounce"></i> จองห้อง</label>
                                        <select class="form-control" id="labRequested" name="labRequested" required>
                                            <option value="" disabled selected>เลือกห้องปฏิบัติการ...</option>
                                            <option value="ฟิสิกส์">ห้องปฏิบัติการฟิสิกส์</option>
                                            <option value="เคมี">ห้องปฏิบัติการเคมี</option>
                                            <option value="ชีววิทยา">ห้องปฏิบัติการชีววิทยา</option>
                                        </select>
                                </div>

                                <div class="col-md-6" style="margin-bottom: 10px;">
                                <label for="startTime"><i class="fas fa-calendar-alt fa-bounce"></i> เริ่มวันที่</label>
                                        <input type="datetime-local" class="form-control" id="startTime" name="startTime" required>
                                </div>

                                <div class="col-md-6" style="margin-bottom: 10px;">
                                <label for="endTime"><i class="fas fa-calendar-check fa-bounce"></i> สิ้นสุดวันที่</label>
                                        <input type="datetime-local" class="form-control" id="endTime" name="endTime" required>
                                </div>

                                <div class="col-md-6" style="margin-bottom: 10px;">
                                <label for="studentGrade"><i class="fas fa-chalkboard-teacher fa-bounce"></i> ห้องที่สอน </label>
                                        <input type="text" class="form-control" id="studentGrade" name="studentGrade" required placeholder="เช่น ม.4/1">
                                </div>


                                <div class="col-md-12" style="margin-bottom: 10px;">
                                <label for="materialsNeeded"><i class="fas fa-tools fa-bounce"></i> สิ่งที่ต้องการ</label>
                                        <textarea class="form-control" id="materialsNeeded" name="materialsNeeded" rows="3" placeholder="ระบุรายการ"></textarea>
                                </div>
                            <div class="col-md-12" style="margin-bottom: 10px;">
                                <button type="submit" class="btn btn-primary btn-block btn-lg"><i class="fas fa-paper-plane"></i> ส่งข้อมูลการจอง</button>
                            </div>
                        </div> </form>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane" id="bookingTableTab">
                 <div class="panel panel-default" style="margin-top:0; box-shadow: none; border: none;">
                    <div class="panel-body" style="padding:0;">
                        <div class="row" style="margin-bottom: 15px;">
                            <div class="col-md-6 form-group">
                                <label for="filterLab">กรองตามห้องปฏิบัติการ:</label>
                                <select id="filterLab" class="form-control input-sm">
                                    <option value="">ทั้งหมด</option>
                                    <option value="ห้องปฏิบัติการฟิสิกส์">ห้องปฏิบัติการฟิสิกส์</option>
                                    <option value="ห้องปฏิบัติการเคมี">ห้องปฏิบัติการเคมี</option>
                                    <option value="ห้องปฏิบัติการชีววิทยา">ห้องปฏิบัติการชีววิทยา</option>
                                </select>
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="filterDate">กรองตามวันเริ่มต้น:</label>
                                <input type="date" id="filterDate" class="form-control input-sm">
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="bookingTable" class="table table-striped table-hover" style="width:100%">
                                </table>
                        </div>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane" id="calendarViewTab">
                <div id="bookingCalendar" style="margin-top: 20px;"></div>
            </div>
        </div> <footer style="text-align: center;background-color:#faff99; padding: 10px 0; margin-top: 10px; border-top: 1px solid #e0e0e0; font-size: 0.9em; color: #555; width: 100%;">
    :: Created and Develop by KT|Tanasarn Sirak ::
	<div class="container text-center">
	<a href="https://line.me/ti/p/3F7VGrqgUr" target="_blank"><i class="fa-solid fa-comments"></i></a> <a style="color:red;text-decoration:none;font-size:12px" href="https://line.me/ti/p/3F7VGrqgUr" target="_blank"> สอบถาม/แจ้งปัญหา :: <span style="font-size:12px;color:black">KT | Tanasarn Sirak © <script>document.write(new Date().getFullYear()+543)</script> </a>
	</div>
    </footer>
        </div>
		</div>
		</div>
    </div>

    <div class="modal fade" id="eventDetailModal" tabindex="-1" role="dialog" aria-labelledby="eventDetailModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header panel-primary">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true" style="color:white;">&times;</span></button>
                    <h4 class="modal-title" id="eventDetailModalLabel" style="color:black;"><i class="fas fa-info-circle"></i> รายละเอียดการจอง</h4>
                </div>
                <div class="modal-body">
                    <p><strong><i class="fas fa-microscope"></i> ห้องที่จอง:</strong> <span id="eventLab"></span></p>
                    <p><strong><i class="fas fa-user"></i> ชื่อผู้จอง:</strong> <span id="eventRequester"></span></p>
                    <p><strong><i class="fas fa-calendar-alt"></i> วันที่เริ่มต้น:</strong> <span id="eventStart"></span></p>
                    <p><strong><i class="fas fa-calendar-check"></i> วันที่สิ้นสุด:</strong> <span id="eventEnd"></span></p>
                    <p><strong><i class="fas fa-chalkboard-teacher"></i> สอนห้อง:</strong> <span id="eventGrade"></span></p>
                    <p><strong><i class="fas fa-tools"></i> สิ่งที่ต้องการ:</strong> <span id="eventMaterials"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/th.js'></script>


    <script>
        // Configuration
        const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxLkTyNDbj1fGlA8Rsi4xPNiz6CBaUwt1fkFxTIfHQM2C-XpRM2mVxbSz6AkOic2r4/exec';

        let mockBookings = []; // Used for client-side overlap check
        let bookingCalendarInstance = null; // Holds the FullCalendar instance
        let allFetchedBookings = []; // Holds all data fetched from the server

        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOMContentLoaded: Event listener added"); // LOG 15
            const bookingForm = document.getElementById('bookingForm');

            initializeDatePickers();
            fetchBookingsAndInitTable(); // Initial fetch for table and calendar

            bookingForm.addEventListener('submit', handleFormSubmit);

            document.getElementById('filterLab').addEventListener('change', function() {
                $('#bookingTable').DataTable().column(0).search(this.value).draw();
            });
            document.getElementById('filterDate').addEventListener('change', function() {
                 $.fn.dataTable.ext.search.push(
                    function(settings, data, dataIndex) {
                        if (settings.nTable.id !== 'bookingTable') {
                            return true;
                        }
                        var filterDateVal = $('#filterDate').val();
                        var tableDateCell = data[1];

                        if (filterDateVal === '' || filterDateVal === null) {
                            return true;
                        }
                        if (!tableDateCell) {
                            return false;
                        }
                        var tableDate = '';
                        if (tableDateCell.includes('/')) { // Assuming format DD/MM/YYYY HH:mm from formatTableDateTime
                            const parts = tableDateCell.split(' ')[0].split('/');
                            if (parts.length === 3) {
                                // Convert DD/MM/YYYY to YYYY-MM-DD for comparison
                                tableDate = `${parts[2] - 543}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            } else {
                                return false;
                            }
                        } else { // Assuming ISO format like YYYY-MM-DDTHH:mm:ss.sssZ
                            tableDate = tableDateCell.substring(0,10);
                        }
                        return tableDate === filterDateVal;
                    }
                );
                $('#bookingTable').DataTable().draw();
                $.fn.dataTable.ext.search.pop();
            });

            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                const targetTab = e.target.hash;
                console.log("Tab switched: targetTab -", targetTab); // LOG 16
                if (targetTab === '#bookingTableTab') {
                    $($.fn.dataTable.tables(true)).DataTable().responsive.recalc().columns.adjust();
                } else if (targetTab === '#calendarViewTab') {
                    console.log("Calendar tab shown. bookingCalendarInstance -", bookingCalendarInstance); // LOG 17
                    if (bookingCalendarInstance) {
                        console.log("Calendar tab: Calling updateSize()"); // LOG 18
                        bookingCalendarInstance.updateSize();
                    } else {
                        console.warn("Calendar tab: bookingCalendarInstance is null, attempting to re-initialize or fetch."); // LOG 19
                        if (allFetchedBookings.length > 0 && document.getElementById('bookingCalendar')) {
                             console.log("Calendar tab: Re-initializing with existing allFetchedBookings"); // LOG 20
                            initializeBookingCalendar(allFetchedBookings);
                        } else if (document.getElementById('bookingCalendar')) {
                            console.log("Calendar tab: No existing data, calling fetchBookingsAndInitTable()"); // LOG 21
                            fetchBookingsAndInitTable();
                        } else {
                            console.error("Calendar tab: bookingCalendar element not found, cannot initialize."); // LOG 22
                        }
                    }
                }
            });
        });

        function initializeDatePickers() {
            const now = new Date();
            const minDate = new Date(now);
            minDate.setMinutes(now.getMinutes() + 1); // Allow booking from the next minute

            const maxDate = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            maxDate.setHours(23, 59, 59, 999);


            const formatDateTimeLocal = (date) => {
                const pad = (num) => String(num).padStart(2, '0');
                return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
            };

            const minDateTimeLocal = formatDateTimeLocal(minDate);
            const maxDateForPicker = formatDateTimeLocal(new Date(maxDate.getFullYear(), maxDate.getMonth(), maxDate.getDate(), 23, 59));


            document.getElementById('startTime').min = minDateTimeLocal;
            document.getElementById('startTime').max = maxDateForPicker;
            document.getElementById('endTime').min = minDateTimeLocal;
            document.getElementById('endTime').max = maxDateForPicker;
        }

        function formatUserDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleDateString('th-TH', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function formatUserTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes} น.`;
        }

        function checkBookingOverlap(lab, start, end, currentBookingId = null) {
            const newStart = new Date(start);
            const newEnd = new Date(end);

            for (const booking of mockBookings) {
                if (booking.id === currentBookingId) continue;

                if (booking.labRequested === lab) {
                    const existingStart = new Date(booking.startTime);
                    const existingEnd = new Date(booking.endTime);
                    if (newStart < existingEnd && newEnd > existingStart) {
                        return true;
                    }
                }
            }
            return false;
        }

        async function handleFormSubmit(event) {
            event.preventDefault();

            const lab = document.getElementById('labRequested').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const requesterName = document.getElementById('requesterName').value;


            const startDate = new Date(startTime);
            const endDate = new Date(endTime);
            const now = new Date();

            const minAllowedStart = new Date(document.getElementById('startTime').min);
            const maxAllowedBookingDate = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            maxAllowedBookingDate.setHours(23, 59, 59, 999);


            if (startDate < minAllowedStart) {
                 Swal.fire({ icon: 'error', title: 'เวลาไม่ถูกต้อง', text: 'ไม่สามารถเลือกวัน/เวลาเริ่มต้นในอดีตหรือปัจจุบันขณะได้ กรุณาเลือกเวลาในอนาคต' });
                 return;
            }
            if (endDate <= startDate) {
                Swal.fire({ icon: 'error', title: 'เวลาไม่ถูกต้อง', text: 'วัน/เวลาสิ้นสุดต้องอยู่หลังวัน/เวลาเริ่มต้น' });
                return;
            }
            if (startDate > maxAllowedBookingDate || endDate > maxAllowedBookingDate) {
                Swal.fire({ icon: 'error', title: 'เวลาไม่ถูกต้อง', text: 'สามารถจองล่วงหน้าได้ไม่เกิน 1 สัปดาห์เท่านั้น (นับถึงสิ้นสุดวันที่ 7)' });
                return;
            }

            if (checkBookingOverlap(lab, startTime, endTime)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่สามารถจองได้',
                    text: `ห้องปฏิบัติการ ${lab} ไม่ว่างในช่วงเวลาที่คุณเลือก (วันที่ ${formatUserDate(startTime)} เวลา ${formatUserTime(startTime)} ถึง วันที่ ${formatUserDate(endTime)} เวลา ${formatUserTime(endTime)}). กรุณาตรวจสอบตารางหรือปฏิทินและเลือกเวลาอื่น`,
                });
                return;
            }

            const formData = new FormData(event.target);

            Swal.fire({
                title: 'กำลังส่งข้อมูล...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    let errorText = `HTTP error! Status: ${response.status}`;
                    try {
                        const errorResult = await response.json();
                        errorText = errorResult.message || errorText;
                    } catch (e) { /* Use existing errorText */ }
                    throw new Error(errorText);
                }

                const result = await response.json();

                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'จองสำเร็จ!',
                        text: result.message || 'ข้อมูลการจองของคุณถูกบันทึกแล้ว',
                    });
                    event.target.reset();
                    initializeDatePickers();
                    fetchBookingsAndInitTable();
                    $('.nav-tabs a[href="#bookingTableTab"]').tab('show');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'การจองไม่สำเร็จ',
                        text: result.message || 'ไม่สามารถบันทึกข้อมูลการจองได้ กรุณาลองใหม่อีกครั้ง',
                    });
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาดในการเชื่อมต่อ',
                    text: 'ไม่สามารถติดต่อเซิร์ฟเวอร์ได้: ' + error.message,
                });
            }
        }

        function formatTableDateTime(dateTimeString) {
            if (!dateTimeString) return '';
            const date = new Date(dateTimeString);
            return date.toLocaleString('th-TH', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: false
            }).replace(',', '');
        }

        function getLabColor(labName) {
            if (!labName) return '#777777';
            if (labName.includes('ฟิสิกส์')) return '#007bff';
            if (labName.includes('เคมี')) return '#ffc107';
            if (labName.includes('ชีววิทยา')) return '#28a745';
            return '#6c757d';
        }

        function initializeBookingCalendar(bookingsData) {
            console.log("initializeBookingCalendar: Function called with data -", bookingsData); // LOG 7
            const calendarEl = document.getElementById('bookingCalendar');
            console.log("initializeBookingCalendar: calendarEl -", calendarEl); // LOG 8

            if (!calendarEl) {
                console.error("Calendar element with ID 'bookingCalendar' not found!");
                return;
            }

            const events = bookingsData.map(booking => ({
                id: booking.bookingID || booking.id,
                title: `${booking.labRequested || 'N/A'} (${booking.requesterName || 'N/A'})`,
                start: booking.startTime,
                end: booking.endTime,
                extendedProps: {
                    lab: booking.labRequested,
                    requester: booking.requesterName,
                    grade: booking.studentGrade,
                    materials: booking.materialsNeeded,
                    startTimeFull: booking.startTime,
                    endTimeFull: booking.endTime
                },
                color: getLabColor(booking.labRequested)
            }));
            console.log("initializeBookingCalendar: Mapped events -", events); // LOG 9

            if (bookingCalendarInstance) {
                console.log("initializeBookingCalendar: Destroying existing calendar instance"); // LOG 10
                bookingCalendarInstance.destroy();
            }

            console.log("initializeBookingCalendar: Creating new FullCalendar instance"); // LOG 11
            bookingCalendarInstance = new FullCalendar.Calendar(calendarEl, {
                locale: 'th',
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                events: events,
                eventClick: function(info) {
                    const props = info.event.extendedProps;
                    document.getElementById('eventLab').textContent = props.lab || '-';
                    document.getElementById('eventRequester').textContent = props.requester || '-';
                    document.getElementById('eventStart').textContent = formatTableDateTime(props.startTimeFull);
                    document.getElementById('eventEnd').textContent = formatTableDateTime(props.endTimeFull);
                    document.getElementById('eventGrade').textContent = props.grade || '-';
                    document.getElementById('eventMaterials').textContent = props.materials || '-';

                    $('#eventDetailModal').modal('show');
                },
                slotMinTime: '08:00:00',
                slotMaxTime: '18:00:00',
                height: 'auto',
                stickyHeaderDates: true,
                windowResize: function(arg) {
                    // This is often handled by updateSize on tab show
                },
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false,
                    meridiem: false
                }
            });

            console.log("initializeBookingCalendar: Calendar instance created, about to render"); // LOG 12
            try {
                bookingCalendarInstance.render();
                console.log("initializeBookingCalendar: render() called successfully"); // LOG 13
            } catch (e) {
                console.error("initializeBookingCalendar: Error during render() -", e); // LOG 14
            }
        }


        async function fetchBookingsAndInitTable() {
            console.log("fetchBookingsAndInitTable: Function called"); // LOG 1
            Swal.fire({
                title: 'กำลังโหลดข้อมูลการจอง...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL);
                console.log("fetchBookingsAndInitTable: Fetch response status -", response.status); // LOG 2
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}. ${errorText.substring(0,200)}`);
                }
                let fetchedBookingsFromServer = await response.json();
                console.log("fetchBookingsAndInitTable: Fetched data from server -", fetchedBookingsFromServer); // LOG 3


                if (!Array.isArray(fetchedBookingsFromServer)) {
                     console.warn("Fetched data is not an array, using empty array. Raw data:", fetchedBookingsFromServer);
                     fetchedBookingsFromServer = [];
                }

                allFetchedBookings = fetchedBookingsFromServer;
                console.log("fetchBookingsAndInitTable: allFetchedBookings populated -", allFetchedBookings); // LOG 4


                mockBookings = allFetchedBookings.map(b => ({
                    id: b.bookingID || b.id,
                    labRequested: b.labRequested,
                    startTime: b.startTime,
                    endTime: b.endTime,
                }));

                const isDataTable = $.fn.DataTable.isDataTable('#bookingTable');

                if (isDataTable) {
                    $('#bookingTable').DataTable().clear().rows.add(allFetchedBookings).draw();
                } else {
                    $('#bookingTable').DataTable({
                        data: allFetchedBookings,
                        columns: [
                            { data: 'labRequested', title: 'ห้องปฏิบัติการ' },
                            {
                                data: 'startTime', title: 'วัน/เวลาเริ่มต้น',
                                render: data => formatTableDateTime(data)
                            },
                            {
                                data: 'endTime', title: 'วัน/เวลาสิ้นสุด',
                                render: data => formatTableDateTime(data)
                            },
                            { data: 'requesterName', title: 'ชื่อผู้ขอใช้' },
                            { data: 'studentGrade', title: 'ห้องที่สอน' },
                            { data: 'materialsNeeded', title: 'วัสดุ/อุปกรณ์/สารเคมี' }
                        ],
                        responsive: true,
                        order: [[1, 'desc']],
                        language: { url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Thai.json' },
                    });
                }

                console.log("fetchBookingsAndInitTable: About to call initializeBookingCalendar"); // LOG 5
                initializeBookingCalendar(allFetchedBookings);

                if ($('#bookingTableTab').hasClass('active') || !isDataTable) {
                     setTimeout(function() {
                        $($.fn.dataTable.tables(true)).DataTable().responsive.recalc().columns.adjust();
                    }, 200);
                }
                Swal.close();

            } catch (error) {
                console.error("Error fetching bookings:", error); // LOG 6
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาดในการโหลดข้อมูล',
                    text: 'ไม่สามารถดึงข้อมูลการจองได้: ' + error.message
                });
                if (!$.fn.DataTable.isDataTable('#bookingTable')) {
                    $('#bookingTable').DataTable({
                        responsive: true,
                        columns: [
                            { title: 'ห้องปฏิบัติการที่ขอใช้' }, { title: 'วัน/เวลาเริ่มต้น'},
                            { title: 'วัน/เวลาสิ้นสุด'}, { title: 'ชื่อผู้ขอใช้' },
                            { title: 'ห้องที่สอน' }, { title: 'วัสดุ/อุปกรณ์/สารเคมี' }
                        ],
                        language: {
                            url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Thai.json',
                            emptyTable: "ไม่สามารถโหลดข้อมูลการจองได้ หรือยังไม่มีการจอง"
                        }
                    });
                }
                const calendarEl = document.getElementById('bookingCalendar');
                if (calendarEl) {
                    calendarEl.innerHTML = `<div class="alert alert-danger text-center">ขออภัย, ไม่สามารถโหลดข้อมูลปฏิทินได้: ${error.message}</div>`;
                }
            }
        }
    </script>
</body>
</html>
